<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Adivina mi número - RL en el navegador</title>
  <style>
    :root {
      font-family: "Segoe UI", Tahoma, sans-serif;
      color: #1c1e21;
      background: #f8fafc;
      line-height: 1.5;
    }

    body {
      margin: 0 auto;
      max-width: 1100px;
      padding: 32px 24px 56px;
    }

    h1 {
      margin-bottom: 0.25rem;
    }

    h2 {
      margin-top: 2rem;
    }

    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
      border: 1px solid #e1e7ef;
      margin-top: 16px;
    }

    .grid {
      display: grid;
      gap: 12px;
    }

    @media (min-width: 700px) {
      .grid.two {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    label {
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      font-size: 14px;
      box-sizing: border-box;
    }

    button {
      padding: 12px 16px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.16s ease;
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.26);
    }

    .metrics {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .pill {
      background: #e0f2fe;
      color: #0f172a;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 600;
      border: 1px solid #bfdbfe;
    }

    .log {
      background: #0f172a;
      color: #e2e8f0;
      font-family: "SFMono-Regular", "Consolas", monospace;
      padding: 14px;
      border-radius: 10px;
      max-height: 320px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .progress {
      background: #e2e8f0;
      border-radius: 10px;
      height: 12px;
      overflow: hidden;
      position: relative;
    }

    .progress span {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      transition: width 0.2s ease;
    }

    .hint {
      color: #475569;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>Juego "Adivina mi número" con un agente de RL</h1>
  <p>El agente entrena 100% en el navegador con Q-learning tabular. El objetivo es adivinar números de 4 dígitos sin repetir y sin empezar en 0. Las recompensas se basan en la pista recibida (dígitos correctos y posición).</p>

  <div class="card">
    <h2>1. Entrenar al agente</h2>
    <div class="grid two">
      <div>
        <label for="episodes">Episodios</label>
        <input id="episodes" type="number" min="100" step="100" value="2000" />
      </div>
      <div>
        <label for="epsilon">Exploración (ε)</label>
        <input id="epsilon" type="number" min="0" max="1" step="0.05" value="0.2" />
      </div>
      <div>
        <label for="alpha">Tasa de aprendizaje (α)</label>
        <input id="alpha" type="number" min="0" max="1" step="0.05" value="0.5" />
      </div>
      <div>
        <label for="gamma">Factor de descuento (γ)</label>
        <input id="gamma" type="number" min="0" max="1" step="0.05" value="0.4" />
      </div>
      <div>
        <label for="maxAttempts">Intentos máximos por episodio</label>
        <input id="maxAttempts" type="number" min="4" max="12" step="1" value="8" />
      </div>
      <div style="display:flex;align-items:flex-end;gap:10px;">
        <button id="trainBtn">Entrenar agente</button>
        <button id="resetBtn" style="background:linear-gradient(135deg,#94a3b8,#64748b);">Reiniciar Q</button>
      </div>
    </div>

    <div style="margin-top:16px;" class="hint">Durante el entrenamiento cada episodio genera un número secreto aleatorio. El agente gana más recompensa cuando acierta dígitos y posición, y una leve penalización por cada intento usado.</div>

    <div class="progress" aria-label="Progreso de entrenamiento">
      <span id="progressBar" style="width: 0%"></span>
    </div>
    <div class="metrics">
      <div class="pill" id="episodesInfo">0 episodios</div>
      <div class="pill" id="successInfo">Tasa de acierto: 0%</div>
      <div class="pill" id="attemptsInfo">Intentos promedio: 0</div>
    </div>
  </div>

  <div class="card">
    <h2>2. Prueba: el agente intenta adivinar tu número</h2>
    <div class="grid two">
      <div>
        <label for="secretInput">Escribe tu número secreto</label>
        <input id="secretInput" type="text" placeholder="Ej: 4821" />
        <div class="hint">Debe tener 4 dígitos únicos y no iniciar en 0.</div>
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button id="guessBtn">¡Deja que el agente lo adivine!</button>
      </div>
    </div>
    <div class="log" id="guessLog">Entrena al agente y luego escribe tu número para probarlo.</div>
  </div>

  <div class="card">
    <h2>Bitácora</h2>
    <div class="log" id="trainLog">Listo para entrenar.</div>
  </div>

  <script>
    const digits = Array.from({ length: 10 }, (_, i) => i);

    function allCandidates() {
      const combos = [];
      for (let a = 1; a <= 9; a++) {
        for (let b = 0; b <= 9; b++) {
          if (b === a) continue;
          for (let c = 0; c <= 9; c++) {
            if (c === a || c === b) continue;
            for (let d = 0; d <= 9; d++) {
              if (d === a || d === b || d === c) continue;
              combos.push(`${a}${b}${c}${d}`);
            }
          }
        }
      }
      return combos;
    }

    function evaluateGuess(secret, guess) {
      let bulls = 0;
      let cows = 0;
      for (let i = 0; i < 4; i++) {
        if (secret[i] === guess[i]) {
          bulls += 1;
        } else if (secret.includes(guess[i])) {
          cows += 1;
        }
      }
      return { bulls, cows };
    }

    function isConsistent(candidate, guess, feedback) {
      const result = evaluateGuess(candidate, guess);
      return result.bulls === feedback.bulls && result.cows === feedback.cows;
    }

    function filterCandidates(candidates, guess, feedback) {
      return candidates.filter((cand) => isConsistent(cand, guess, feedback));
    }

    class RLAgent {
      constructor() {
        this.allNumbers = allCandidates();
        this.qValues = new Map();
        this.alpha = 0.5;
        this.gamma = 0.4;
        this.epsilon = 0.2;
        this.maxAttempts = 8;
      }

      setHyperParams({ alpha, gamma, epsilon, maxAttempts }) {
        this.alpha = Number(alpha);
        this.gamma = Number(gamma);
        this.epsilon = Number(epsilon);
        this.maxAttempts = Number(maxAttempts);
      }

      resetQ() {
        this.qValues.clear();
      }

      getQ(guess) {
        return this.qValues.get(guess) ?? 0;
      }

      pickGuess(candidates, exploration = this.epsilon) {
        if (!candidates.length) {
          return this.allNumbers[Math.floor(Math.random() * this.allNumbers.length)];
        }
        if (Math.random() < exploration) {
          return candidates[Math.floor(Math.random() * candidates.length)];
        }
        let best = [];
        let bestScore = -Infinity;
        for (const candidate of candidates) {
          const value = this.getQ(candidate);
          if (value > bestScore) {
            bestScore = value;
            best = [candidate];
          } else if (value === bestScore) {
            best.push(candidate);
          }
        }
        return best[Math.floor(Math.random() * best.length)];
      }

      updateQ(guess, reward, maxNext) {
        const current = this.getQ(guess);
        const updated = current + this.alpha * (reward + this.gamma * maxNext - current);
        this.qValues.set(guess, updated);
      }

      runEpisode(secretNumber) {
        const target = secretNumber || this.allNumbers[Math.floor(Math.random() * this.allNumbers.length)];
        let candidates = [...this.allNumbers];
        let attempts = 0;
        let success = false;

        while (attempts < this.maxAttempts) {
          attempts += 1;
          const guess = this.pickGuess(candidates);
          const feedback = evaluateGuess(target, guess);
          const reward = feedback.bulls * 2 + feedback.cows * 0.5 - 0.1;
          candidates = filterCandidates(candidates, guess, feedback);
          const maxNext = candidates.length ? Math.max(...candidates.map((c) => this.getQ(c))) : 0;
          this.updateQ(guess, reward, maxNext);
          if (feedback.bulls === 4) {
            success = true;
            break;
          }
        }

        return { attempts, success };
      }

      async train(episodes, onProgress) {
        let successes = 0;
        let totalAttempts = 0;
        const reportEvery = Math.max(1, Math.floor(episodes / 50));

        for (let i = 1; i <= episodes; i++) {
          const { attempts, success } = this.runEpisode();
          totalAttempts += attempts;
          if (success) successes += 1;

          if (i % reportEvery === 0 || i === episodes) {
            onProgress({
              episode: i,
              progress: (i / episodes) * 100,
              successRate: (successes / i) * 100,
              avgAttempts: totalAttempts / i,
            });
            await new Promise((resolve) => setTimeout(resolve));
          }
        }

        return {
          episodes,
          successes,
          successRate: (successes / episodes) * 100,
          avgAttempts: totalAttempts / episodes,
        };
      }

      guessSecret(secretNumber) {
        if (!this.allNumbers.includes(secretNumber)) {
          throw new Error("El número no cumple las reglas (4 dígitos únicos y sin empezar en 0)");
        }
        let candidates = [...this.allNumbers];
        const attemptsLog = [];
        let solved = false;

        for (let step = 1; step <= this.maxAttempts; step++) {
          const guess = this.pickGuess(candidates, 0); // política pura tras entrenamiento
          const feedback = evaluateGuess(secretNumber, guess);
          attemptsLog.push({ step, guess, feedback });
          if (feedback.bulls === 4) {
            solved = true;
            break;
          }
          candidates = filterCandidates(candidates, guess, feedback);
        }

        return { solved, attemptsLog };
      }
    }

    const agent = new RLAgent();

    const trainLog = document.getElementById("trainLog");
    const guessLog = document.getElementById("guessLog");
    const progressBar = document.getElementById("progressBar");
    const episodesInfo = document.getElementById("episodesInfo");
    const successInfo = document.getElementById("successInfo");
    const attemptsInfo = document.getElementById("attemptsInfo");

    function appendTrainLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      trainLog.textContent = `[${timestamp}] ${message}\n` + trainLog.textContent;
    }

    function validateSecret(value) {
      if (!/^\d{4}$/.test(value)) return false;
      if (value[0] === "0") return false;
      const set = new Set(value.split(""));
      return set.size === 4;
    }

    async function handleTrain() {
      const episodes = Number(document.getElementById("episodes").value) || 1000;
      const epsilon = Number(document.getElementById("epsilon").value) || 0.2;
      const alpha = Number(document.getElementById("alpha").value) || 0.5;
      const gamma = Number(document.getElementById("gamma").value) || 0.4;
      const maxAttempts = Number(document.getElementById("maxAttempts").value) || 8;

      agent.setHyperParams({ alpha, gamma, epsilon, maxAttempts });

      appendTrainLog(`Entrenamiento iniciado: ${episodes} episodios, ε=${epsilon}, α=${alpha}, γ=${gamma}.`);
      toggleButtons(true);

      const stats = await agent.train(episodes, ({ episode, progress, successRate, avgAttempts }) => {
        progressBar.style.width = `${progress.toFixed(1)}%`;
        episodesInfo.textContent = `${episode} / ${episodes} episodios`;
        successInfo.textContent = `Tasa de acierto: ${successRate.toFixed(1)}%`;
        attemptsInfo.textContent = `Intentos promedio: ${avgAttempts.toFixed(2)}`;
      });

      appendTrainLog(
        `Entrenamiento terminado. Aciertos: ${stats.successes}/${stats.episodes} (${stats.successRate.toFixed(
          1
        )}%). Intentos prom.: ${stats.avgAttempts.toFixed(2)}.`
      );
      toggleButtons(false);
    }

    function toggleButtons(disabled) {
      document.getElementById("trainBtn").disabled = disabled;
      document.getElementById("resetBtn").disabled = disabled;
      document.getElementById("guessBtn").disabled = disabled;
    }

    function handleReset() {
      agent.resetQ();
      progressBar.style.width = "0%";
      episodesInfo.textContent = "0 episodios";
      successInfo.textContent = "Tasa de acierto: 0%";
      attemptsInfo.textContent = "Intentos promedio: 0";
      appendTrainLog("Tabla Q reiniciada.");
    }

    function handleGuess() {
      const secret = document.getElementById("secretInput").value.trim();
      if (!validateSecret(secret)) {
        guessLog.textContent = "Número inválido. Usa 4 dígitos únicos y no empieces en 0.";
        return;
      }

      const { solved, attemptsLog } = agent.guessSecret(secret);
      const lines = attemptsLog
        .map(({ step, guess, feedback }) =>
          `Intento ${step}: ${guess} -> ${feedback.bulls} bien colocados, ${feedback.cows} mal colocados`
        )
        .join("\n");

      guessLog.textContent = lines + `\nResultado: ${solved ? "¡Adivinado!" : "No lo encontró a tiempo"}`;
    }

    document.getElementById("trainBtn").addEventListener("click", handleTrain);
    document.getElementById("resetBtn").addEventListener("click", handleReset);
    document.getElementById("guessBtn").addEventListener("click", handleGuess);
  </script>
</body>
</html>
