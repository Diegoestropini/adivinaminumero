<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Adivina mi número - RL en el navegador</title>
  <style>
    :root {
      font-family: "Segoe UI", Tahoma, sans-serif;
      line-height: 1.5;
      color: var(--text-primary);
      background: var(--bg-primary);
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --text-primary: #0f172a;
      --text-muted: #475569;
      --border: #e1e7ef;
      --shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
      --pill-bg: #e0f2fe;
      --pill-border: #bfdbfe;
      --pill-text: #0f172a;
      --log-bg: #0f172a;
      --log-text: #e2e8f0;
      --progress-bg: #e2e8f0;
    }

    [data-theme="dark"] {
      --bg-primary: #0b1221;
      --bg-secondary: #111a2e;
      --text-primary: #e2e8f0;
      --text-muted: #94a3b8;
      --border: #1e293b;
      --shadow: 0 12px 30px rgba(0, 0, 0, 0.55);
      --pill-bg: #1e293b;
      --pill-border: #334155;
      --pill-text: #e2e8f0;
      --log-bg: #0b1021;
      --log-text: #e2e8f0;
      --progress-bg: #1f2937;
    }

    body {
      margin: 0 auto;
      max-width: 1100px;
      padding: 32px 24px 56px;
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: background 0.2s ease, color 0.2s ease;
    }

    h1 {
      margin-bottom: 0.25rem;
    }

    h2 {
      margin-top: 2rem;
    }

    .card {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      margin-top: 16px;
      transition: background 0.2s ease, border 0.2s ease, box-shadow 0.2s ease;
    }

    .grid {
      display: grid;
      gap: 12px;
    }

    @media (min-width: 700px) {
      .grid.two {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    label {
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 14px;
      box-sizing: border-box;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    input::placeholder {
      color: var(--text-muted);
    }

    button {
      padding: 12px 16px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.16s ease, filter 0.2s ease;
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
    }

    button.secondary {
      background: linear-gradient(135deg, #94a3b8, #64748b);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.26);
      filter: brightness(1.05);
    }

    .metrics {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .pill {
      background: var(--pill-bg);
      color: var(--pill-text);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 600;
      border: 1px solid var(--pill-border);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .pill strong {
      letter-spacing: 0.5px;
    }

    .log {
      background: var(--log-bg);
      color: var(--log-text);
      font-family: "SFMono-Regular", "Consolas", monospace;
      padding: 14px;
      border-radius: 10px;
      max-height: 320px;
      overflow-y: auto;
      white-space: pre-wrap;
      border: 1px solid var(--border);
    }

    .progress {
      background: var(--progress-bg);
      border-radius: 10px;
      height: 12px;
      overflow: hidden;
      position: relative;
    }

    .progress span {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      transition: width 0.2s ease;
    }

    .hint {
      color: var(--text-muted);
      font-size: 14px;
    }

    .mode-switch {
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .pill.muted {
      background: transparent;
      color: var(--text-muted);
      border: 1px dashed var(--border);
    }

    .pill.success {
      background: #22c55e1a;
      border-color: #22c55e55;
      color: #16a34a;
    }

    .pill.error {
      background: #ef44441a;
      border-color: #ef444466;
      color: #ef4444;
    }

    .inline-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .guess-display {
      font-size: 32px;
      font-weight: 800;
      letter-spacing: 2px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      padding: 12px 18px;
      border-radius: 10px;
      min-width: 130px;
      text-align: center;
      box-shadow: var(--shadow);
    }
  </style>
</head>
<body>
  <div class="mode-switch">
    <div>
      <h1>Juego "Adivina mi número" con un agente de RL</h1>
      <p>El agente entrena 100% en el navegador con Q-learning tabular. El objetivo es adivinar números de 4 dígitos sin repetir y sin empezar en 0. Las recompensas se basan en la pista recibida (dígitos correctos y posición).</p>
    </div>
    <button id="themeToggle" class="secondary">Alternar modo claro/oscuro</button>
  </div>

  <div class="card">
    <h2>1. Entrenar al agente</h2>
    <div class="grid two">
      <div>
        <label for="episodes">Episodios</label>
        <input id="episodes" type="number" min="100" step="100" value="10000" />
      </div>
      <div>
        <label for="epsilonStart">Exploración inicial (ε)</label>
        <input id="epsilonStart" type="number" min="0" max="1" step="0.05" value="0.8" />
      </div>
      <div>
        <label for="epsilonEnd">Exploración final (ε)</label>
        <input id="epsilonEnd" type="number" min="0" max="1" step="0.05" value="0.05" />
      </div>
      <div>
        <label for="alpha">Tasa de aprendizaje (α)</label>
        <input id="alpha" type="number" min="0" max="1" step="0.05" value="0.2" />
      </div>
      <div>
        <label for="gamma">Factor de descuento (γ)</label>
        <input id="gamma" type="number" min="0" max="1" step="0.05" value="0.9" />
      </div>
      <div>
        <label for="maxAttempts">Intentos máximos por episodio</label>
        <input id="maxAttempts" type="number" min="4" max="12" step="1" value="8" />
      </div>
      <div style="display:flex;align-items:flex-end;gap:10px;">
        <button id="trainBtn">Entrenar agente</button>
        <button id="resetBtn" style="background:linear-gradient(135deg,#94a3b8,#64748b);">Reiniciar Q</button>
      </div>
    </div>

    <div style="margin-top:16px;" class="hint">Durante el entrenamiento cada episodio genera un número secreto aleatorio. El agente gana más recompensa cuando acierta dígitos y posición, y una leve penalización por cada intento usado.</div>

    <div class="progress" aria-label="Progreso de entrenamiento">
      <span id="progressBar" style="width: 0%"></span>
    </div>
    <div class="metrics">
      <div class="pill" id="episodesInfo">0 episodios</div>
      <div class="pill" id="successInfo">Tasa de acierto: 0%</div>
      <div class="pill" id="attemptsInfo">Intentos promedio: 0</div>
    </div>
  </div>

  <div class="card">
    <h2>2. Prueba: el agente intenta adivinar tu número</h2>
    <div class="grid two">
      <div>
        <label for="secretInput">Modo 1: escribe tu número secreto</label>
        <input id="secretInput" type="text" placeholder="Ej: 4821" />
        <div class="hint">Debe tener 4 dígitos únicos y no iniciar en 0.</div>
      </div>
      <div style="display:flex;align-items:flex-end;gap:10px;">
        <button id="guessBtn">¡Deja que el agente lo adivine!</button>
      </div>
    </div>
    <div class="log" id="guessLog">Entrena al agente y luego escribe tu número para probarlo.</div>

    <div class="grid two" style="margin-top:18px;align-items:flex-start;">
      <div style="display:flex;flex-direction:column;gap:10px;">
        <label>Modo 2: juega por turnos contra el agente</label>
        <div class="inline-group">
          <button id="startInteractiveBtn">Nueva sesión de pistas</button>
          <span class="pill muted">El agente propondrá un número y también guardará uno secreto. Se alternan los turnos.</span>
        </div>
        <div class="inline-group">
          <div>
            <label for="agentSecretInput">Número del agente (opcional)</label>
            <input id="agentSecretInput" type="text" placeholder="Déjalo vacío para uno aleatorio" />
          </div>
          <span class="hint">Si lo completas, el agente usará ese número secreto en la partida.</span>
        </div>
        <div class="inline-group" style="align-items:center;">
          <label style="margin:0;">¿Quién empieza?</label>
          <label><input type="radio" name="starter" value="agent" checked /> El agente</label>
          <label><input type="radio" name="starter" value="user" /> Tú</label>
        </div>
        <div class="inline-group">
          <div>
            <label>Sugerencia actual</label>
            <div class="guess-display" id="currentGuess">----</div>
          </div>
          <div>
            <label for="bullsInput">Bien colocados</label>
            <input id="bullsInput" type="number" min="0" max="4" value="0" />
          </div>
          <div>
            <label for="cowsInput">Mal colocados</label>
            <input id="cowsInput" type="number" min="0" max="4" value="0" />
          </div>
          <button id="feedbackBtn" class="secondary">Enviar pista y siguiente intento</button>
        </div>
        <div class="inline-group">
          <div>
            <label for="userGuessInput">Tu intento al número del agente</label>
            <input id="userGuessInput" type="text" placeholder="Ej: 5731" />
          </div>
          <button id="userGuessBtn">Comprobar mi intento</button>
        </div>
        <div class="hint">Ejemplo: si el agente dice 1234 y tu número es 1325, ingresa 2 bien colocados y 1 mal colocado.</div>
      </div>
      <div>
        <div class="log" id="interactiveLog">Pulsa "Nueva sesión de pistas" para comenzar.</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Bitácora</h2>
    <div class="log" id="trainLog">Listo para entrenar.</div>
  </div>

  <script>
    const digits = Array.from({ length: 10 }, (_, i) => i);

    function allCandidates() {
      const combos = [];
      for (let a = 1; a <= 9; a++) {
        for (let b = 0; b <= 9; b++) {
          if (b === a) continue;
          for (let c = 0; c <= 9; c++) {
            if (c === a || c === b) continue;
            for (let d = 0; d <= 9; d++) {
              if (d === a || d === b || d === c) continue;
              combos.push(`${a}${b}${c}${d}`);
            }
          }
        }
      }
      return combos;
    }

    function evaluateGuess(secret, guess) {
      const s = String(secret);
      const g = String(guess);

      const secretCounts = new Map();
      let bulls = 0;
      let cows = 0;

      for (let i = 0; i < 4; i++) {
        if (s[i] === g[i]) {
          bulls += 1;
        } else {
          secretCounts.set(s[i], (secretCounts.get(s[i]) ?? 0) + 1);
        }
      }

      for (let i = 0; i < 4; i++) {
        if (s[i] === g[i]) continue;
        const available = secretCounts.get(g[i]) ?? 0;
        if (available > 0) {
          cows += 1;
          secretCounts.set(g[i], available - 1);
        }
      }

      return { bulls, cows };
    }

    function isConsistent(candidate, guess, feedback) {
      const result = evaluateGuess(candidate, guess);
      return result.bulls === feedback.bulls && result.cows === feedback.cows;
    }

    function filterCandidates(candidates, guess, feedback) {
      return candidates.filter((cand) => isConsistent(cand, guess, feedback));
    }

    class RLAgent {
      constructor() {
        this.allNumbers = allCandidates();
        this.qValues = new Map();
        this.alpha = 0.2;
        this.gamma = 0.9;
        this.epsilonStart = 0.8;
        this.epsilonEnd = 0.05;
        this.maxAttempts = 8;
      }

      setHyperParams({ alpha, gamma, epsilonStart, epsilonEnd, maxAttempts }) {
        this.alpha = Number(alpha);
        this.gamma = Number(gamma);
        this.epsilonStart = Number(epsilonStart);
        this.epsilonEnd = Number(epsilonEnd);
        this.maxAttempts = Number(maxAttempts);
      }

      resetQ() {
        this.qValues.clear();
      }

      getQ(guess) {
        return this.qValues.get(guess) ?? 0;
      }

      pickGuess(candidates, exploration = this.epsilonStart) {
        if (!candidates.length) {
          return this.allNumbers[Math.floor(Math.random() * this.allNumbers.length)];
        }
        if (Math.random() < exploration) {
          return candidates[Math.floor(Math.random() * candidates.length)];
        }
        let best = [];
        let bestScore = -Infinity;
        for (const candidate of candidates) {
          const value = this.getQ(candidate);
          if (value > bestScore) {
            bestScore = value;
            best = [candidate];
          } else if (value === bestScore) {
            best.push(candidate);
          }
        }
        return best[Math.floor(Math.random() * best.length)];
      }

      updateQ(guess, reward, maxNext) {
        const current = this.getQ(guess);
        const updated = current + this.alpha * (reward + this.gamma * maxNext - current);
        this.qValues.set(guess, updated);
      }

      runEpisode(secretNumber, exploration = this.epsilonStart) {
        const target = secretNumber || this.allNumbers[Math.floor(Math.random() * this.allNumbers.length)];
        let candidates = [...this.allNumbers];
        let attempts = 0;
        let success = false;

        while (attempts < this.maxAttempts) {
          attempts += 1;
          const guess = this.pickGuess(candidates, exploration);
          const feedback = evaluateGuess(target, guess);
          const reward = feedback.bulls * 2 + feedback.cows * 0.5 - 0.1;
          candidates = filterCandidates(candidates, guess, feedback);
          const maxNext = candidates.length ? Math.max(...candidates.map((c) => this.getQ(c))) : 0;
          this.updateQ(guess, reward, maxNext);
          if (feedback.bulls === 4) {
            success = true;
            break;
          }
        }

        return { attempts, success };
      }

      async train(episodes, onProgress) {
        let successes = 0;
        let totalAttempts = 0;
        const reportEvery = Math.max(1, Math.floor(episodes / 50));
        const decaySteps = Math.max(1, episodes - 1);

        for (let i = 1; i <= episodes; i++) {
          const decayRatio = (i - 1) / decaySteps;
          const epsilon = this.epsilonStart - (this.epsilonStart - this.epsilonEnd) * decayRatio;
          const { attempts, success } = this.runEpisode(undefined, epsilon);
          totalAttempts += attempts;
          if (success) successes += 1;

          if (i % reportEvery === 0 || i === episodes) {
            onProgress({
              episode: i,
              progress: (i / episodes) * 100,
              successRate: (successes / i) * 100,
              avgAttempts: totalAttempts / i,
            });
            await new Promise((resolve) => setTimeout(resolve));
          }
        }

        return {
          episodes,
          successes,
          successRate: (successes / episodes) * 100,
          avgAttempts: totalAttempts / episodes,
        };
      }

      guessSecret(secretNumber) {
        if (!this.allNumbers.includes(secretNumber)) {
          throw new Error("El número no cumple las reglas (4 dígitos únicos y sin empezar en 0)");
        }
        let candidates = [...this.allNumbers];
        const attemptsLog = [];
        let solved = false;

        for (let step = 1; step <= this.maxAttempts; step++) {
          const guess = this.pickGuess(candidates, 0); // política pura tras entrenamiento
          const feedback = evaluateGuess(secretNumber, guess);
          attemptsLog.push({ step, guess, feedback });
          if (feedback.bulls === 4) {
            solved = true;
            break;
          }
          candidates = filterCandidates(candidates, guess, feedback);
        }

        return { solved, attemptsLog };
      }
    }

    const agent = new RLAgent();

    const trainLog = document.getElementById("trainLog");
    const guessLog = document.getElementById("guessLog");
    const interactiveLog = document.getElementById("interactiveLog");
    const progressBar = document.getElementById("progressBar");
    const episodesInfo = document.getElementById("episodesInfo");
    const successInfo = document.getElementById("successInfo");
    const attemptsInfo = document.getElementById("attemptsInfo");
    const themeToggle = document.getElementById("themeToggle");
    const currentGuessEl = document.getElementById("currentGuess");
    const startInteractiveBtn = document.getElementById("startInteractiveBtn");
    const feedbackBtn = document.getElementById("feedbackBtn");
    const bullsInput = document.getElementById("bullsInput");
    const cowsInput = document.getElementById("cowsInput");
    const userGuessInput = document.getElementById("userGuessInput");
    const userGuessBtn = document.getElementById("userGuessBtn");
    const agentSecretInput = document.getElementById("agentSecretInput");

    let interactiveState = { active: false, candidates: [], lastGuess: null, steps: 0 };

    function appendTrainLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      trainLog.textContent = `[${timestamp}] ${message}\n` + trainLog.textContent;
    }

    function appendInteractiveLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      interactiveLog.textContent = `[${timestamp}] ${message}\n` + interactiveLog.textContent;
    }

    function applyTheme(theme) {
      document.body.setAttribute("data-theme", theme);
      localStorage.setItem("preferred-theme", theme);
      themeToggle.textContent = theme === "dark" ? "Cambiar a modo claro" : "Cambiar a modo oscuro";
    }

    function initTheme() {
      const stored = localStorage.getItem("preferred-theme");
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      const theme = stored || (prefersDark ? "dark" : "light");
      applyTheme(theme);
    }

    function validateSecret(value) {
      if (!/^\d{4}$/.test(value)) return false;
      if (value[0] === "0") return false;
      const set = new Set(value.split(""));
      return set.size === 4;
    }

    async function handleTrain() {
      const episodes = Number(document.getElementById("episodes").value) || 1000;
      const epsilonStart = Number(document.getElementById("epsilonStart").value) || 0.8;
      const epsilonEnd = Number(document.getElementById("epsilonEnd").value) || 0.05;
      const alpha = Number(document.getElementById("alpha").value) || 0.2;
      const gamma = Number(document.getElementById("gamma").value) || 0.9;
      const maxAttempts = Number(document.getElementById("maxAttempts").value) || 8;

      agent.setHyperParams({ alpha, gamma, epsilonStart, epsilonEnd, maxAttempts });

      appendTrainLog(
        `Entrenamiento iniciado: ${episodes} episodios, ε ${epsilonStart} → ${epsilonEnd}, α=${alpha}, γ=${gamma}.`
      );
      toggleButtons(true);

      const stats = await agent.train(episodes, ({ episode, progress, successRate, avgAttempts }) => {
        progressBar.style.width = `${progress.toFixed(1)}%`;
        episodesInfo.textContent = `${episode} / ${episodes} episodios`;
        successInfo.textContent = `Tasa de acierto: ${successRate.toFixed(1)}%`;
        attemptsInfo.textContent = `Intentos promedio: ${avgAttempts.toFixed(2)}`;
      });

      appendTrainLog(
        `Entrenamiento terminado. Aciertos: ${stats.successes}/${stats.episodes} (${stats.successRate.toFixed(
          1
        )}%). Intentos prom.: ${stats.avgAttempts.toFixed(2)}.`
      );
      toggleButtons(false);
    }

    function toggleButtons(disabled) {
      document.getElementById("trainBtn").disabled = disabled;
      document.getElementById("resetBtn").disabled = disabled;
      document.getElementById("guessBtn").disabled = disabled;
      startInteractiveBtn.disabled = disabled;
      feedbackBtn.disabled = disabled;
      userGuessBtn.disabled = disabled;
    }

    function handleReset() {
      agent.resetQ();
      progressBar.style.width = "0%";
      episodesInfo.textContent = "0 episodios";
      successInfo.textContent = "Tasa de acierto: 0%";
      attemptsInfo.textContent = "Intentos promedio: 0";
      appendTrainLog("Tabla Q reiniciada.");
    }

    function startInteractiveSession() {
      const starter = document.querySelector('input[name="starter"]:checked')?.value || "agent";
      const chosenAgentSecret = agentSecretInput.value.trim();

      if (chosenAgentSecret && !validateSecret(chosenAgentSecret)) {
        interactiveLog.textContent = "El número del agente no es válido. Usa 4 dígitos únicos y sin empezar en 0.";
        return;
      }

      const agentSecret = chosenAgentSecret || agent.allNumbers[Math.floor(Math.random() * agent.allNumbers.length)];
      interactiveState = {
        active: true,
        candidates: [...agent.allNumbers],
        lastGuess: null,
        steps: 0,
        agentSecret,
        turn: starter,
        agentAttempts: 0,
        userAttempts: 0,
        winner: null,
      };
      bullsInput.value = 0;
      cowsInput.value = 0;
      currentGuessEl.textContent = "----";
      userGuessInput.value = "";
      interactiveLog.textContent = "Sesión iniciada. Usa los campos para indicar pistas del número secreto.";
      appendInteractiveLog(
        `Nueva partida. El agente usará ${
          chosenAgentSecret ? "el número que elegiste" : "un número aleatorio"
        }. Empieza: ${starter === "agent" ? "el agente" : "tú"}.`
      );
      if (starter === "agent") {
        requestNextGuess();
      } else {
        promptUserTurn();
      }
    }

    function requestNextGuess() {
      if (!interactiveState.active || interactiveState.turn !== "agent") return;
      if (!interactiveState.candidates.length) {
        interactiveLog.textContent = "Sin candidatos consistentes. Verifica las pistas ingresadas.";
        currentGuessEl.textContent = "----";
        interactiveState.active = false;
        return;
      }
      interactiveState.steps += 1;
      const guess = agent.pickGuess(interactiveState.candidates, 0);
      interactiveState.lastGuess = guess;
      currentGuessEl.textContent = guess;
      appendInteractiveLog(`Intento ${interactiveState.steps}: el agente propone ${guess}.`);
    }

    function promptUserTurn() {
      if (!interactiveState.active || interactiveState.turn !== "user") return;
      currentGuessEl.textContent = "Tu turno";
      appendInteractiveLog("Es tu turno: ingresa un número para intentar adivinar al agente.");
    }

    function handleFeedback() {
      if (!interactiveState.active || interactiveState.turn !== "agent" || !interactiveState.lastGuess) {
        interactiveLog.textContent = "Inicia una sesión de pistas primero.";
        return;
      }

      const bulls = Number(bullsInput.value);
      const cows = Number(cowsInput.value);

      if ([bulls, cows].some((n) => Number.isNaN(n) || n < 0 || n > 4) || bulls + cows > 4) {
        interactiveLog.textContent = "Valores inválidos. Usa números entre 0 y 4 y que la suma no supere 4.";
        return;
      }

      const feedback = { bulls, cows };
      appendInteractiveLog(
        `Pistas recibidas para ${interactiveState.lastGuess}: ${bulls} bien colocados, ${cows} mal colocados.`
      );

      if (bulls === 4) {
        interactiveState.winner = "agente";
        interactiveLog.textContent = `¡El agente acertó el número ${interactiveState.lastGuess}! (Gana el agente)`;
        currentGuessEl.textContent = interactiveState.lastGuess;
        interactiveState.active = false;
        return;
      }

      interactiveState.agentAttempts += 1;

      if (interactiveState.agentAttempts >= agent.maxAttempts) {
        interactiveState.winner = "usuario";
        interactiveState.active = false;
        interactiveLog.textContent =
          "El agente agotó sus intentos sin acertar tu número. ¡Ganaste la partida!";
        currentGuessEl.textContent = "----";
        return;
      }

      interactiveState.candidates = filterCandidates(interactiveState.candidates, interactiveState.lastGuess, feedback);

      if (!interactiveState.candidates.length) {
        interactiveLog.textContent = "Sin candidatos consistentes tras las pistas. Revisa los valores ingresados.";
        currentGuessEl.textContent = "----";
        interactiveState.active = false;
        return;
      }

      interactiveState.turn = "user";
      promptUserTurn();
    }

    function handleUserGuess() {
      if (!interactiveState.active || interactiveState.turn !== "user") {
        interactiveLog.textContent = "Espera a que sea tu turno o inicia una sesión.";
        return;
      }

      const guess = userGuessInput.value.trim();
      if (!validateSecret(guess)) {
        interactiveLog.textContent = "Ingresa un número válido: 4 dígitos únicos y sin empezar en 0.";
        return;
      }

      const feedback = evaluateGuess(interactiveState.agentSecret, guess);
      interactiveState.userAttempts += 1;
      appendInteractiveLog(
        `Tu intento ${interactiveState.userAttempts}: ${guess} -> ${feedback.bulls} bien colocados, ${feedback.cows} mal colocados.`
      );

      if (feedback.bulls === 4) {
        interactiveState.winner = "usuario";
        interactiveState.active = false;
        currentGuessEl.textContent = guess;
        interactiveLog.textContent = `¡Adivinaste el número del agente (${guess})! Ganas la partida.`;
        return;
      }

      if (interactiveState.userAttempts >= agent.maxAttempts) {
        interactiveState.active = false;
        interactiveState.winner = "agente";
        interactiveLog.textContent =
          "Agotaste tus intentos sin adivinar el número del agente. Gana el agente esta vez.";
        return;
      }

      interactiveState.turn = "agent";
      requestNextGuess();
    }

    function handleGuess() {
      const secret = document.getElementById("secretInput").value.trim();
      if (!validateSecret(secret)) {
        guessLog.textContent = "Número inválido. Usa 4 dígitos únicos y no empieces en 0.";
        return;
      }

      const { solved, attemptsLog } = agent.guessSecret(secret);
      const lines = attemptsLog
        .map(({ step, guess, feedback }) =>
          `Intento ${step}: ${guess} -> ${feedback.bulls} bien colocados, ${feedback.cows} mal colocados`
        )
        .join("\n");

      guessLog.textContent = lines + `\nResultado: ${solved ? "¡Adivinado!" : "No lo encontró a tiempo"}`;
    }

    document.getElementById("trainBtn").addEventListener("click", handleTrain);
    document.getElementById("resetBtn").addEventListener("click", handleReset);
    document.getElementById("guessBtn").addEventListener("click", handleGuess);
    startInteractiveBtn.addEventListener("click", startInteractiveSession);
    feedbackBtn.addEventListener("click", handleFeedback);
    userGuessBtn.addEventListener("click", handleUserGuess);
    themeToggle.addEventListener("click", () => {
      const current = document.body.getAttribute("data-theme") === "dark" ? "light" : "dark";
      applyTheme(current);
    });

    initTheme();
  </script>
</body>
</html>
